# Анализ проблем с MAIB Callback

## Выявленные проблемы

### 1. Неправильная верификация подписи
**Проблема**: В методе `verifyCallback` использовался HMAC SHA256 вместо простого SHA256 с Base64.

**Исправление**: Обновлен алгоритм в `src/lib/maib-client.ts`:
- Изменен с HMAC на SHA256
- Добавлено Base64 кодирование
- Параметры сортируются и объединяются через двоеточие

### 2. Неправильная структура данных callback
**Проблема**: Код ожидал данные напрямую в теле запроса, но MAIB отправляет их в объекте `result`.

**Исправление**: Обновлен `src/app/api/payments/maib/callback/route.ts`:
- Извлечение данных из `body.result`
- Обработка случаев, когда `result` отсутствует

### 3. Неправильное извлечение подписи
**Проблема**: Подпись извлекалась из заголовков, но MAIB отправляет её в теле запроса.

**Исправление**: 
- Подпись теперь извлекается из `body.result.signature`
- Добавлена fallback логика для заголовков

### 4. Неправильный маппинг статусов
**Проблема**: Статус 'OK' не обрабатывался как успешный платеж.

**Исправление**: Добавлен 'OK' в список статусов для 'completed'.

### 5. Неправильный URL в .env.local
**Проблема**: `NEXT_PUBLIC_APP_URL` был настроен на неправильный порт.

**Исправление**: Обновлен на актуальный порт сервера разработки.

## Возможные причины отсутствия callback

1. **Блокировка IP**: MAIB может блокировать localhost или определенные IP
2. **Неправильная конфигурация в maibmerchants**: Callback URL должен быть настроен в панели
3. **HTTPS требование**: Production может требовать HTTPS для callback URL
4. **Неправильный домен**: Callback URL должен соответствовать настройкам проекта
5. **Настройки проекта**: В Production Project требуется конфигурация Domain, IP, Platform, Callback URL, Ok URL, и Fail URL
6. **Активация проекта**: Project Secret и Signature Key становятся доступными только после успешной активации проекта

## Инструменты для отладки

### Тестовый endpoint
Создан `src/app/api/test-maib/callback-test/route.ts` для:
- Проверки доступности callback URL
- Логирования IP адресов запросов (проверка на MAIB IP: 91.250.245.70, 91.250.245.71)
- Проверки заголовков и тела запроса

### Логирование
Добавлено расширенное логирование в callback endpoint:
- Заголовки запроса
- Тело запроса
- IP адрес клиента
- Процесс верификации подписи

### Тестирование платежей
Создан тестовый endpoint `src/app/api/test-maib/payment` для создания тестовых платежей с правильными callback URL.

## Проверенные исправления

✅ **Callback URL формируется правильно**: `http://localhost:3001/api/payments/maib/callback`
✅ **Платежи создаются успешно**: Получен payUrl для тестового платежа
✅ **Сервер доступен**: Endpoint отвечает на запросы
✅ **Конфигурация обновлена**: .env.local содержит правильный URL

## Следующие шаги для production

1. **Настроить maibmerchants панель**:
   - Добавить production домен
   - Настроить Callback URL: `https://yourdomain.com/api/payments/maib/callback`
   - Настроить Ok URL и Fail URL
   - Указать IP адрес сервера

2. **Проверить HTTPS**:
   - MAIB может требовать HTTPS для callback в production
   - Убедиться, что SSL сертификат валиден

3. **Мониторинг**:
   - Использовать тестовый endpoint для проверки получения callback
   - Проверить логи на предмет входящих запросов от MAIB IP

4. **Тестирование**:
   - Создать реальный платеж и проследить весь процесс
   - Проверить, что callback приходит после завершения платежа

## Документация MAIB

По документации MAIB (https://docs.maibmerchants.md/ru):
- Callback URL используется для получения финального статуса транзакции
- Signature Key используется для валидации уведомлений
- Production проект требует полной конфигурации в панели maibmerchants

## Алгоритм повторных попыток MAIB

Согласно документации, MAIB повторяет отправку callback через интервалы:
- 10 секунд
- 60 секунд (1 минута)
- 300 секунд (5 минут)
- 600 секунд (10 минут)
- 3600 секунд (1 час)
- 43200 секунд (12 часов)
- 86400 секунд (24 часа)

## Рекомендации для отладки

1. **Проверить логи сервера** на наличие входящих запросов с IP MAIB
2. **Использовать тестовый endpoint** `/api/test-maib/callback-test` для проверки доступности
3. **Проверить настройки файрвола** и разрешить IP адреса MAIB
4. **Убедиться в правильности callback URL** в настройках MAIB проекта
5. **Проверить SSL сертификат** если используется HTTPS
6. **Мониторить debug страницу** `/debug/order/[orderId]` для анализа платежей

## Тестирование

Для тестирования callback можно:
1. Создать тестовый платеж через MAIB
2. Проверить логи на `/api/test-maib/callback-test`
3. Использовать debug API `/api/debug/maib-callbacks/[orderId]`
4. Мониторить основной callback endpoint `/api/payments/maib/callback`