# База данных для системы бронирования билетов

Этот каталог содержит SQL-скрипты для настройки базы данных Supabase.

## Файлы

- `../sql/schema.sql` - Основная схема базы данных с таблицами, функциями и политиками RLS
- `../sql/seed.sql` - Тестовые данные для разработки

## Настройка базы данных

### 1. Создание схемы

Выполните следующие команды в SQL Editor вашего проекта Supabase:

```sql
-- Скопируйте и выполните содержимое файла sql/schema.sql
```

### 2. Заполнение тестовыми данными

После создания схемы выполните:

```sql
-- Скопируйте и выполните содержимое файла sql/seed.sql
```

## Структура базы данных

### Таблицы

1. **users** - Пользователи системы
2. **events** - События/концерты
3. **seats** - Места в зале
4. **bookings** - Бронирования
5. **booking_seats** - Связь бронирований с местами
6. **payments** - Платежи

### Функции

- `update_updated_at_column()` - Автоматическое обновление поля updated_at
- `update_event_seat_counts()` - Обновление счетчиков мест в событии
- `expire_old_bookings()` - Автоматическое истечение старых бронирований

### Политики безопасности (RLS)

- Пользователи могут видеть только свои данные
- Service role имеет полный доступ ко всем данным
- Публичный доступ к событиям и местам для чтения

## Тестовые данные

После выполнения sql/seed.sql в базе будут созданы:

- 1 тестовое событие "Концерт в Ледовом дворце"
- 130 мест в 13 зонах (201-213)
- 1 тестовый пользователь
- 1 тестовое бронирование с 2 местами
- 1 тестовый платеж

## Использование в API

Все API routes в `src/app/api/` уже настроены для работы с этой схемой базы данных.

### Переменные окружения

Убедитесь, что в `.env.local` указаны правильные значения:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```