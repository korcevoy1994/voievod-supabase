# Система очистки временных пользователей

Эта система автоматически очищает временных пользователей для поддержания чистоты базы данных.

## Компоненты системы

### 1. База данных

#### Таблица `users` (обновлена)
Добавлены новые поля:
- `is_temporary` (boolean) - флаг временного пользователя
- `temp_expires_at` (timestamp) - время истечения временного пользователя

#### SQL функции

1. **`cleanup_temporary_users()`**
   - Удаляет временных пользователей (старше 2 дней) без активных бронирований
   - Возвращает количество удаленных записей

2. **`create_temporary_user()`**
   - Создает временного пользователя
   - Устанавливает `is_temporary = true` и `temp_expires_at`

3. **`convert_temp_user_to_permanent()`**
   - Конвертирует временного пользователя в постоянного
   - Убирает флаг `is_temporary` и `temp_expires_at`

#### Применение изменений:
```bash
# Выполните SQL скрипт для обновления схемы базы данных
psql -d your_database -f temp_users_cleanup.sql
```

### 2. API Endpoints

#### `/api/cleanup/temp-users` (POST)
Выполняет очистку временных пользователей:
```json
{
  "token": "your-api-token" // опционально для авторизации
}
```

#### `/api/cleanup/temp-users` (GET)
Возвращает статистику временных пользователей:
```json
{
  "temporary_users_count": 25,
  "expired_temporary_users": 8
}
```

### 3. Автоматическая очистка

#### Настройка cron задачи:
```bash
# Сделайте скрипт исполняемым
chmod +x setup_cleanup_cron.sh

# Запустите скрипт настройки
./setup_cleanup_cron.sh
```

#### Ручная настройка cron:
```bash
# Откройте редактор cron
crontab -e

# Добавьте строку для ежедневной очистки в 2:00
0 2 * * * curl -X POST http://localhost:3001/api/cleanup/temp-users -H 'Content-Type: application/json' >> /var/log/voevoda-cleanup.log 2>&1
```

## Логика работы

### Временные пользователи
- Создаются автоматически при резервировании мест или создании заказов
- Помечаются как `is_temporary = true`
- Устанавливается `temp_expires_at = NOW() + 2 дня`
- Автоматически удаляются через 2 дня, если не связаны с активными бронированиями

### Процесс очистки
1. Удаляются временные пользователи (старше 2 дней), не связанные с:
   - Активными бронированиями
   - Зарезервированными местами
   - Завершенными заказами

## Мониторинг

### Просмотр логов:
```bash
# Логи автоматической очистки
tail -f /var/log/voevoda-cleanup.log

# Логи приложения
npm run dev
```

### Проверка статистики:
```bash
# Получить статистику временных пользователей
curl http://localhost:3001/api/cleanup/temp-users
```

## Безопасность

- API очистки может быть защищен токеном (настройте переменную окружения `CLEANUP_API_TOKEN`)
- Все операции логируются
- Данные удаляются безвозвратно - убедитесь в правильности настроек перед запуском

## Рекомендации

1. **Мониторинг**: Регулярно проверяйте логи очистки
2. **Бэкапы**: Создавайте резервные копии базы данных перед первым запуском
3. **Тестирование**: Протестируйте систему на тестовой среде
4. **Аналитика**: Используйте данные checkout для улучшения конверсии

## Устранение неполадок

### Проблемы с cron:
```bash
# Проверить статус cron
sudo systemctl status cron

# Просмотреть системные логи cron
sudo tail -f /var/log/syslog | grep CRON
```

### Проблемы с базой данных:
```bash
# Проверить подключение к базе данных
psql -d your_database -c "SELECT version();"

# Проверить существование функций
psql -d your_database -c "\df cleanup_temporary_users"
```

### Проблемы с API:
```bash
# Проверить доступность API
curl -I http://localhost:3001/api/cleanup/temp-users

# Тестовый запрос с выводом ошибок
curl -v -X POST http://localhost:3001/api/cleanup/temp-users
```